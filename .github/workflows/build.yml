on: push
jobs:
  build-mingw:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@master
      - env:
          MSYSTEM: MINGW64
        run: |
          $ErrorActionPreference = "Continue"
          C:\msys64\usr\bin\bash.exe -l -c "pacman -Syu --noconfirm --noprogressbar"
          C:\msys64\usr\bin\bash.exe -l -c "pacman -Syu --needed --noconfirm --noprogressbar base-devel cmake git mingw-w64-x86_64-toolchain mingw-w64-x86_64-libarchive mingw-w64-x86_64-boost mingw-w64-x86_64-tinyxml2"
          git fetch --unshallow --tags
          C:\msys64\usr\bin\bash.exe -l -c "
            cd /d/a/LxRunOffline/LxRunOffline &&
            cmake -G 'MSYS Makefiles' -DCMAKE_BUILD_TYPE=Release . &&
            make -j && make test && make package"
          $version = git describe --tags
          move LxRunOffline-$version-msvc.zip LxRunOffline-msvc.zip 
          if ($LASTEXITCODE -ne 0) { Exit 1 }
      - uses: actions/upload-artifact@v3
        with:
          name: LxRunOffline-msvc.zip
          path: LxRunOffline-msvc.zip
